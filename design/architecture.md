# Shotgun App Architecture

## 1. Overview

The Shotgun App is a desktop application built using Wails (v2) and Vue.js (v3).
Wails allows for building cross-platform desktop applications with a Go backend and a web-based frontend.

-   **Backend:** Go. Handles file system operations, logic for identifying files/folders to exclude, and generation of the "Shotgun" text output.
-   **Frontend:** Vue.js (with Vite). Provides the user interface for folder selection, displaying the file/folder tree, marking items for exclusion, and showing the generated output.
-   **Communication:** Wails handles the binding between Go functions and JavaScript calls from the frontend.

## 2. Backend (Go)

The Go backend is structured into a `main` package.

### Key Components:

-   **`main.go`**:
    -   Initializes Wails.
    -   Sets up the application window and options.
    -   Binds the `App` struct methods to be callable from the frontend.
    -   Embeds the frontend assets.
-   **`app.go`**:
    -   **`App` struct**: Holds application state or context if needed (e.g., `context.Context`).
    -   **`startup(ctx context.Context)`**: Wails lifecycle hook, stores the context.
    -   **`FileNode` struct**: Represents a file or folder in the tree. Includes `Name`, `Path`, `RelPath`, `IsDir`, `Children`, and `Excluded` (for UI state).
    -   **`ListFiles(dirPath string) ([]*FileNode, error)`**:
        -   Takes a directory path as input.
        -   Recursively scans the directory.
        -   Builds a tree structure of `FileNode` objects.
        -   Uses `os.ReadDir` and `path/filepath` for file system interaction.
        -   Sorts entries (directories first, then by name).
        -   Returns the tree structure to the frontend.
    -   **`GenerateShotgunOutput(rootDir string, excludedPaths []string) (string, error)`**:
        -   Takes the root directory path and a list of relative paths to exclude.
        -   **Tree Generation**:
            -   Recursively traverses the `rootDir`.
            -   Skips any file or folder whose relative path is in `excludedPaths`. If a folder is excluded, its children are also skipped.
            -   Builds a textual tree representation (e.g., using `├──`, `└──`, `│`).
        -   **File Content Aggregation**:
            -   For each non-excluded file:
                -   Reads its content.
                -   Formats it according to the specified `*#*#*...*#*#*begin*#*#* ... *#*#*end*#*#*` structure.
                -   `filepath_inside_project_dir` is calculated relative to `rootDir`.
        -   **Final Output**:
            -   Concatenates the tree structure, a blank line, and all formatted file contents.
            -   Returns the complete string.

### Wails Integration:

-   The `App` struct and its public methods (`ListFiles`, `GenerateShotgunOutput`) are bound using `wails.Run(&options.App{Bind: ...})`.
-   Wails automatically generates JavaScript bindings in `frontend/wailsjs/go/main/App.js` for these methods, allowing the frontend to call them.
-   For folder selection, the Go backend can expose a method that uses `runtime.OpenDirectoryDialog` from the Wails runtime package. This method is then bound and called from the frontend.

## 3. Frontend (Vue.js)

The frontend is a Single Page Application (SPA) built with Vue 3 (Composition API) and Vite.

### Key Components:

-   **`main.js`**: Entry point for the Vue application. Initializes Vue and mounts the root `App.vue` component.
-   **`App.vue`**: Root component.
    -   **Layout**: Divides the screen into a left panel (controls, file tree) and a right panel (output display).
    -   **State Management (using `ref` and `reactive`)**:
        -   `projectRoot`: Path of the selected project folder.
        -   `fileTree`: Array of `FileNode` objects (reactive, with added UI state like `expanded`).
        -   `excludedNodes`: A `Set` storing `relPath` of user-excluded files/folders.
        -   `shotgunOutput`: The string generated by the backend.
        -   `loadingError`: For displaying errors during file operations.
    -   **Methods**:
        -   `selectProjectFolder()`: Calls a Go-bound method (e.g., `App.SelectDirectory()`) which in turn uses Wails `runtime.OpenDirectoryDialog`. On selection, updates `projectRoot` and calls `loadFileTree`.
        -   `loadFileTree(dirPath)`: Calls the Go backend `ListFiles(dirPath)` method. Updates `fileTree` with the result, mapping data to include UI-specific reactive properties like `expanded`.
        -   `toggleExclude(node)`: Called by `FileTree.vue` component. Updates the `excludedNodes` set (containing `relPath`s) and the `excluded` reactive property on the specific node.
        -   `generateShotgun()`: Calls the Go backend `GenerateShotgunOutput(projectRoot.value, Array.from(excludedNodes))` method. Updates `shotgunOutput` with the result.
-   **`components/FileTree.vue`**: A recursive component to display the file/folder tree.
    -   **Props**: `nodes` (array of `FileNode`), `depth` (for indentation), `parentExcluded`.
    -   **Display**:
        -   Renders each node's name.
        -   Shows a toggler (▶/▼) for expandable directories.
        -   Includes a checkbox for each item to mark it for exclusion/inclusion. The checkbox state reflects `!node.excluded`.
        -   Disables checkbox if the node or an ancestor is excluded.
        -   Recursively renders itself for children of expanded directories.
    -   **Events**: Emits a `toggle-exclude` event with the node object when a checkbox is changed. This event is handled by `App.vue`.
-   **`assets/main.css`**: Basic global styles. Component-specific styles are in `<style scoped>` blocks.
-   **`index.html`**: Main HTML file.
-   **`vite.config.js`**: Vite build configuration.
-   **`package.json`**: Frontend project metadata and dependencies (Vue, Vite).

### Wails Integration:

-   Frontend calls Go methods via `import { MethodName } from '../../wailsjs/go/main/App';`.
-   The `SelectDirectory` functionality is preferably wrapped in a Go method using `runtime.OpenDirectoryDialog(a.ctx, options)` to provide a consistent API and better control over dialog options. This Go method is then bound and callable from JavaScript.

## 4. Data Flow

1.  **Folder Selection**:
    -   User clicks "Select Project Folder" button in Frontend.
    -   Frontend calls Go's `App.SelectDirectory()`.
    -   Go backend uses `runtime.OpenDirectoryDialog` to show dialog. Path is returned to Frontend.
    -   Frontend updates `projectRoot` state and calls Go's `App.ListFiles(selectedPath)`.
2.  **File Tree Display**:
    -   Go's `App.ListFiles` reads the directory structure, creates `FileNode` objects, and returns them to Frontend.
    -   Frontend (`App.vue`) receives the tree data, makes it reactive, and passes it to `FileTree.vue`.
    -   `FileTree.vue` renders the tree. Users can expand/collapse directories.
3.  **Exclusion Marking**:
    -   User clicks a checkbox next to a file/folder in `FileTree.vue`.
    -   `FileTree.vue` emits `toggle-exclude` event with the node.
    -   `App.vue` handles the event, updates the `excludedNodes` set (containing `relPath`s) and the node's `excluded` property.
    -   The UI of `FileTree.vue` updates (e.g., line-through text, disabled children checkboxes).
4.  **"Shotgun" Generation**:
    -   User clicks "Shotgun" button in Frontend.
    -   Frontend (`App.vue`) calls Go's `App.GenerateShotgunOutput(projectRoot, Array.from(excludedNodes))`.
    -   Go backend generates the formatted text (tree structure + file contents), skipping excluded items.
    -   The generated text is returned to Frontend.
    -   Frontend (`App.vue`) updates `shotgunOutput` state, displaying it in the right panel.

## 5. Cross-Platform Considerations

-   **Wails**: Natively supports building for Windows, macOS, and Linux from a single codebase.
-   **Go**: Standard library functions like `os` and `path/filepath` are cross-platform, handling path separators and OS-specific details.
-   **Frontend**: Web technologies (HTML, CSS, JS) are inherently cross-platform.

## 6. Simplicity and Minimal Libraries

-   **Go Backend**: Relies primarily on the Go standard library. Wails is the main external dependency.
-   **Vue Frontend**: Uses Vue 3 and Vite. No heavy UI component libraries; the file tree is a custom Vue component.
-   This approach keeps the application lightweight and reduces external dependencies.